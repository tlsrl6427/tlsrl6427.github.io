---
title: "통계 테이블로 조회시간 줄이기"
category: "Database"
tags: ["부하 테스트", "ngrinder", "scheduler", "batch"]
published: false
---

## 개요

 현재 데이터베이스 서버는 NCP Micro Server(vcpu 1개, RAM 1GB)를 쓰고 있다. 하루 2000~3000건씩 꾸준히 배치를 돌려온 결과 어느덧 데이터가 100만건에 달하게 됐다. 그에따라 점점 쿼리가 느려지기 시작했는데 10만건부터 30초가 넘게 걸리더니 이젠 오래 걸리는 건 5분가까이나 걸리게 되었다.. 프론트를 아직 안만들어서 유기해놓고 있었는데 가끔 테스트해볼때도 너무 불편해서 고치기로 마음먹었다.

## 통계 테이블

  해결 방법으로는 여러가지가 있겠지만 통계 테이블을 따로 만들기로 했다. 예전에 했던 멘토링에서 이미 얘기가 나오기도 했고, 예전 프로젝트때도 리뷰수 같은 것들을 따로 만들어 조회때마다 쿼리를 날리지 않도록 해봤기 때문이다. 보통 느린 쿼리를 해결하려는 노력이 먼저겠지만 여러 테이블을 조인하는 것도 아니고 한 테이블에서 AVG(평균값)같은 연산을 하는 것이기 때문에 쿼리는 변경의 여지가 없었다.   

  이전 프로젝트와 다른 점은, 이전 프로젝트는 리뷰가 하나 만들어질때마다 리뷰수를 한 개씩 늘렸다. 리뷰를 생성하는 로직과 리뷰수를 증가시키는 로직을 분리시키기 위해 AOP를 사용한다거나 동시에 리뷰수를 증가시킬때 값이 누락될 것을 예상해 애플리케이션 단에서 비관적 락을 거는 것을 고려하기도 했다.   
  이번 프로젝트는 대신 일정시간마다 배치를 돌려 평균값을 데이터베이스에 저장한다. 데이터가 늘어날때마다 느린 쿼리를 돌리는 건 곤란하기 때문이다. 평균값과 데이터 수를 두어 데이터가 들어오면 ((평균값 * 데이터 수) + 새로 들어온 데이터) / 총 데이터 수 를 계산하여 값을 저장하는 방법도 있었는데 [소수점이 몇 개까지 되는지, 연산할때마다 손실값은 없는지] 따지는 과정이 배치를 돌리는 것보다 어려워서 배치를 돌리기로 마음먹었다. 그렇다면 배치를 돌릴 때 Spring Batch를 이용해 Jenkins에서 돌릴까? 아니면 @Scheduled를 이용해 cron값을 통해 돌릴까?   

  일단 Jenkins 서버가 이미 있긴 했다. 하지만 이 서버는 하루 2000~3000건을 받아오는데에도 버거워했다. 배치지만 사실상 24시간 돌아가는 느낌이기 때문이다. 파일, 네트워크 I/O가 계속 돌아가서 심지어 Jenkins 사이트를 못 들어갈 때도 있다. 이것도 어찌 해보려했는데 vcpu 1개의 한계라고 일단 결론지었다. 이것도 나중에 다시 봐야되는데..   
  어쨋든 이러한 이유 때문에 API 서버에서 돌려야 될 것 같고, API로 만들어 놓은 Repository와 Service를 사용하고 통계 테이블에 넣어주는 부분만 추가하면 되기도 해서 @Scheduled를 이용해 API 서버에서 배치를 돌리기로 했다. 

## 구현

 이제 고려해야될 것은 한 가지인데.. 저장은 할건데 어떻게 저장하냐는 것이었다. 각각 API 마다 데이터 형식이 조금씩 달랐다. Double 값이 1개만 나오는 것, Double 값이 여러개 나오는 것, id·count가 리스트 형식으로 나오는 것 등등... 이 문제는 프론트에서 어떻게 나타내냐로 이어지는데 각각의 API마다 템플릿을 만들어야한다. 아무튼 그래서 저장방식은 간단하게 ObjectMapper로 Json 맵핑하기로 했다. 그래서 최종적으로

  1. N분마다 @Scheduled로 배치돌리기
  2. 통계 쿼리를 날려서 값 받아오기
  3. 받은 값을 Json으로 변환해 통계 테이블에 저장하기
  4. API가 날아오면 통계 테이블에서 Json 가져온 것을 재변환해 반환

 이렇게 되겠다. 

## 결과

![img1](img1.png)

↑ API V1(느린 쿼리 버전)

![img1](img1.png)

↑ API V2(통계 테이블 버전)

 비교를 할 수 없을 정도의 차이가 난다. 그럴듯한 지표를 보여주기 위해 ngrinder도 세팅했는데 커넥션 시간이 너무 길어져서 Too many error가 떠서 접었다. 사실 이 정도차이면 간단히 결과만 보여주는게 낫겠다도 싶다.

## 통계 테이블 장단점

## 추가로 해볼만한 것

 Redis
 mysql event scheduler + procedure


